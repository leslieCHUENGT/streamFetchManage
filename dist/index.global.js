"use strict";var easyWebStore=(()=>{var f=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames,O=Object.getOwnPropertySymbols;var q=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var H=(a,e,t)=>e in a?f(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,R=(a,e)=>{for(var t in e||(e={}))q.call(e,t)&&H(a,t,e[t]);if(O)for(var t of O(e))U.call(e,t)&&H(a,t,e[t]);return a};var D=(a,e)=>{for(var t in e)f(a,t,{get:e[t],enumerable:!0})},W=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of L(e))!q.call(a,n)&&n!==t&&f(a,n,{get:()=>e[n],enumerable:!(r=N(e,n))||r.enumerable});return a};var _=a=>W(f({},"__esModule",{value:!0}),a);var Q={};D(Q,{CacheManager:()=>u,MessageProcessor:()=>m,StreamFetchClient:()=>C});var u=class{constructor(e={}){this.messageCache=new Map,this.maxCacheSize=e.maxCacheSize||100,this.cacheTimeout=e.cacheTimeout||5e3,this.cleanupInterval=null,this.initCleanupCycle()}initCleanupCycle(){this.cleanupInterval=setInterval(()=>this.cleanup(),3e4)}cleanup(){this.applyTimeBasedEviction(),this.applySizeBasedEviction()}applyTimeBasedEviction(){let e=Date.now();Array.from(this.messageCache.entries()).forEach(([t,{timestamp:r}])=>{e-r>=this.cacheTimeout&&this.messageCache.delete(t)})}applySizeBasedEviction(){for(;this.messageCache.size>=this.maxCacheSize;){let e=Array.from(this.messageCache.keys())[0];this.messageCache.delete(e)}}cacheMessage(e,t){this.applySizeBasedEviction(),this.messageCache.set(e,{data:t,timestamp:Date.now()})}getCachedMessage(e){let t=this.messageCache.get(e);if(t){if(Date.now()-t.timestamp>this.cacheTimeout){this.messageCache.delete(e);return}return t}}deleteMessage(e){this.messageCache.delete(e)}clear(){this.messageCache.clear()}};var m=class{constructor(e=0,t,r,n,i){this.expectedSeq=0;this.expectedSeq=e,this.cacheManager=t,this.handleAppMessage=r,this.handleValidateMessageFormat=n,this.getIndexValue=i}processMessage(e){try{this.handleValidateMessageFormat(e);let t=this.getIndexValue(e);t===this.expectedSeq?this.handleCurrentMessage(e):t>this.expectedSeq&&this.cacheManager.cacheMessage(t,e)}catch(t){console.error("\u6D88\u606F\u5904\u7406\u9519\u8BEF:",t)}}handleCurrentMessage(e){this.handleAppMessage(e),this.expectedSeq++,this.checkCacheForNext()}checkCacheForNext(){for(;this.cacheManager.messageCache.has(this.expectedSeq);){let e=this.cacheManager.getCachedMessage(this.expectedSeq);e&&(this.handleAppMessage(e.data),this.cacheManager.deleteMessage(this.expectedSeq),this.expectedSeq++)}}};async function k(a,e){let t=a.getReader(),r;for(;!(r=await t.read()).done;)e(r.value)}function z(a){let e,t,r,n=!1;return function(s){e===void 0?(e=s,t=0,r=-1):e=J(e,s);let o=e.length,c=0;for(;t<o;){n&&(e[t]===10&&(c=++t),n=!1);let l=-1;for(;t<o&&l===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-c);break;case 13:n=!0;case 10:l=t;break}if(l===-1)break;a(e.subarray(c,l),r),c=t,r=-1}c===o?e=void 0:c!==0&&(e=e.subarray(c),t-=c)}}function F(a,e,t){let r=P(),n=new TextDecoder;return function(s,o){if(s.length===0)t==null||t(r),r=P();else if(o>0){let c=n.decode(s.subarray(0,o)),l=o+(s[o+1]===32?2:1),d=n.decode(s.subarray(l));switch(c){case"data":r.data=r.data?r.data+`
`+d:d;break;case"event":r.event=d;break;case"id":a(r.id=d);break;case"retry":let p=parseInt(d,10);isNaN(p)||e(r.retry=p);break}}}}function J(a,e){let t=new Uint8Array(a.length+e.length);return t.set(a),t.set(e,a.length),t}function P(){return{data:"",event:"",id:"",retry:void 0}}var $=function(a,e){var t={};for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&e.indexOf(r)<0&&(t[r]=a[r]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,r=Object.getOwnPropertySymbols(a);n<r.length;n++)e.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(a,r[n])&&(t[r[n]]=a[r[n]]);return t},b="text/event-stream",K=1e3,A="last-event-id";function x(a,e){var{signal:t,headers:r,onopen:n,onmessage:i,onclose:s,onerror:o,openWhenHidden:c,fetch:l}=e,d=$(e,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((p,V)=>{let v=Object.assign({},r);v.accept||(v.accept=b);let g;function w(){g.abort(),document.hidden||S()}c||document.addEventListener("visibilitychange",w);let I=K,E=0;function M(){document.removeEventListener("visibilitychange",w),window.clearTimeout(E),g.abort()}t==null||t.addEventListener("abort",()=>{M(),p()});let j=l!=null?l:window.fetch,B=n!=null?n:G;async function S(){var T;g=new AbortController;try{let y=await j(a,Object.assign(Object.assign({},d),{headers:v,signal:g.signal}));await B(y),await k(y.body,z(F(h=>{h?v[A]=h:delete v[A]},h=>{I=h},i))),s==null||s(),M(),p()}catch(y){if(!g.signal.aborted)try{let h=(T=o==null?void 0:o(y))!==null&&T!==void 0?T:I;window.clearTimeout(E),E=window.setTimeout(S,h)}catch(h){M(),V(h)}}}S()})}function G(a){let e=a.headers.get("content-type");if(!(e!=null&&e.startsWith(b)))throw new Error(`Expected content-type to be ${b}, Actual: ${e}`)}var C=class{constructor(e,t,r){this.cacheManager=null;this.messageProcessor=null;this.baseUrl=e.baseUrl||"",this.headers=e.headers||{"Content-Type":"application/json"},this.overErrorTimer=e.overErrorTimer||60*1e3,this.currentEventHandlers=t||{onMessage:()=>{}},this.abortController=null,this.streamTimer=null,r&&(this.cacheManager=new u({maxCacheSize:r.maxCacheSize,cacheTimeout:r.cacheTimeout}),this.messageProcessor=new m(r.expectedSeq,this.cacheManager,this.currentEventHandlers.onMessage,r.handleValidateMessageFormat,r.getIndexValue))}async sendStreamRequest(e,t){this.currentEventHandlers=t||this.currentEventHandlers,this.abortController=new AbortController;try{this.startTimer(),await this.executeFetchRequest(e)}catch(r){this.handleRequestError()}finally{this.clearTimer()}}disconnect(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.clearTimer()}async executeFetchRequest(e){var t;await x(this.baseUrl,{method:"POST",headers:this.headers,body:JSON.stringify(this.buildRequestPayload(e)),openWhenHidden:!0,signal:(t=this.abortController)==null?void 0:t.signal,onopen:async r=>{this.handleOpenResponse(r)},onmessage:r=>this.handleServerMessage(r),onclose:()=>this.handleStreamClose(),onerror:()=>this.handleStreamError()})}handleServerMessage(e){var t,r,n,i;this.resetTimer();try{let s=JSON.parse(e.data);if(this.messageProcessor){this.messageProcessor.processMessage(s);return}(r=(t=this.currentEventHandlers)==null?void 0:t.onMessage)==null||r.call(t,s),this.currentMessage=s}catch(s){(i=(n=this.currentEventHandlers)==null?void 0:n.onParseError)==null||i.call(n,this.currentMessage)}}buildRequestPayload(e){return R({},e)}handleOpenResponse(e){var r,n,i,s;e.ok&&e.headers.get("content-type")==="text/event-stream"||(e.status>=400&&e.status<500&&e.status!==429&&((n=(r=this.currentEventHandlers)==null?void 0:r.onServerError)==null||n.call(r,this.currentMessage)),(s=(i=this.currentEventHandlers)==null?void 0:i.onConnectionError)==null||s.call(i,this.currentMessage))}handleStreamClose(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onClose)==null||t.call(e,this.currentMessage),this.clearTimer()}handleStreamError(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onServerError)==null||t.call(e,this.currentMessage),this.clearTimer()}handleRequestError(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onServerError)==null||t.call(e,this.currentMessage),this.clearTimer()}startTimer(){this.streamTimer=setTimeout(()=>{var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onStreamConnectionError)==null||t.call(e,this.currentMessage),this.disconnect()},this.overErrorTimer)}resetTimer(){this.clearTimer(),this.startTimer()}clearTimer(){this.streamTimer&&(clearTimeout(this.streamTimer),this.streamTimer=null)}};return _(Q);})();
