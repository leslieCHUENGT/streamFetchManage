"use strict";var easyWebStore=(()=>{var y=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames,O=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var P=(a,e,t)=>e in a?y(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,R=(a,e)=>{for(var t in e||(e={}))H.call(e,t)&&P(a,t,e[t]);if(O)for(var t of O(e))U.call(e,t)&&P(a,t,e[t]);return a};var D=(a,e)=>{for(var t in e)y(a,t,{get:e[t],enumerable:!0})},W=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of L(e))!H.call(a,s)&&s!==t&&y(a,s,{get:()=>e[s],enumerable:!(r=N(e,s))||r.enumerable});return a};var _=a=>W(y({},"__esModule",{value:!0}),a);var X={};D(X,{CacheManager:()=>u,MessageProcessor:()=>m,StreamFetchClient:()=>C,TypeWriterManage:()=>E});var u=class{constructor(e={}){this.messageCache=new Map,this.maxCacheSize=e.maxCacheSize||100,this.cacheTimeout=e.cacheTimeout||5e3,this.cleanupInterval=null,this.initCleanupCycle()}initCleanupCycle(){this.cleanupInterval=setInterval(()=>this.cleanup(),3e4)}cleanup(){this.applyTimeBasedEviction(),this.applySizeBasedEviction()}applyTimeBasedEviction(){let e=Date.now();Array.from(this.messageCache.entries()).forEach(([t,{timestamp:r}])=>{e-r>=this.cacheTimeout&&this.messageCache.delete(t)})}applySizeBasedEviction(){for(;this.messageCache.size>=this.maxCacheSize;){let e=Array.from(this.messageCache.keys())[0];this.messageCache.delete(e)}}cacheMessage(e,t){this.applySizeBasedEviction(),this.messageCache.set(e,{data:t,timestamp:Date.now()})}getCachedMessage(e){let t=this.messageCache.get(e);if(t){if(Date.now()-t.timestamp>this.cacheTimeout){this.messageCache.delete(e);return}return t}}deleteMessage(e){this.messageCache.delete(e)}clear(){this.messageCache.clear()}};var m=class{constructor(e=0,t,r,s,i){this.expectedSeq=0;this.expectedSeq=e,this.cacheManager=t,this.handleAppMessage=r,this.handleValidateMessageFormat=s,this.getIndexValue=i}processMessage(e){try{this.handleValidateMessageFormat(e);let t=this.getIndexValue(e);t===this.expectedSeq?this.handleCurrentMessage(e):t>this.expectedSeq&&this.cacheManager.cacheMessage(t,e)}catch(t){console.error("\u6D88\u606F\u5904\u7406\u9519\u8BEF:",t)}}handleCurrentMessage(e){this.handleAppMessage(e),this.expectedSeq++,this.checkCacheForNext()}checkCacheForNext(){for(;this.cacheManager.messageCache.has(this.expectedSeq);){let e=this.cacheManager.getCachedMessage(this.expectedSeq);e&&(this.handleAppMessage(e.data),this.cacheManager.deleteMessage(this.expectedSeq),this.expectedSeq++)}}};async function z(a,e){let t=a.getReader(),r;for(;!(r=await t.read()).done;)e(r.value)}function k(a){let e,t,r,s=!1;return function(n){e===void 0?(e=n,t=0,r=-1):e=J(e,n);let o=e.length,c=0;for(;t<o;){s&&(e[t]===10&&(c=++t),s=!1);let h=-1;for(;t<o&&h===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-c);break;case 13:s=!0;case 10:h=t;break}if(h===-1)break;a(e.subarray(c,h),r),c=t,r=-1}c===o?e=void 0:c!==0&&(e=e.subarray(c),t-=c)}}function A(a,e,t){let r=q(),s=new TextDecoder;return function(n,o){if(n.length===0)t==null||t(r),r=q();else if(o>0){let c=s.decode(n.subarray(0,o)),h=o+(n[o+1]===32?2:1),d=s.decode(n.subarray(h));switch(c){case"data":r.data=r.data?r.data+`
`+d:d;break;case"event":r.event=d;break;case"id":a(r.id=d);break;case"retry":let p=parseInt(d,10);isNaN(p)||e(r.retry=p);break}}}}function J(a,e){let t=new Uint8Array(a.length+e.length);return t.set(a),t.set(e,a.length),t}function q(){return{data:"",event:"",id:"",retry:void 0}}var $=function(a,e){var t={};for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&e.indexOf(r)<0&&(t[r]=a[r]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(a);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(a,r[s])&&(t[r[s]]=a[r[s]]);return t},b="text/event-stream",K=1e3,Q="last-event-id";function w(a,e){var{signal:t,headers:r,onopen:s,onmessage:i,onclose:n,onerror:o,openWhenHidden:c,fetch:h}=e,d=$(e,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((p,V)=>{let v=Object.assign({},r);v.accept||(v.accept=b);let g;function I(){g.abort(),document.hidden||S()}c||document.addEventListener("visibilitychange",I);let F=K,T=0;function M(){document.removeEventListener("visibilitychange",I),window.clearTimeout(T),g.abort()}t==null||t.addEventListener("abort",()=>{M(),p()});let j=h!=null?h:window.fetch,B=s!=null?s:G;async function S(){var x;g=new AbortController;try{let f=await j(a,Object.assign(Object.assign({},d),{headers:v,signal:g.signal}));await B(f),await z(f.body,k(A(l=>{l?v[Q]=l:delete v[Q]},l=>{F=l},i))),n==null||n(),M(),p()}catch(f){if(!g.signal.aborted)try{let l=(x=o==null?void 0:o(f))!==null&&x!==void 0?x:F;window.clearTimeout(T),T=window.setTimeout(S,l)}catch(l){M(),V(l)}}}S()})}function G(a){let e=a.headers.get("content-type");if(!(e!=null&&e.startsWith(b)))throw new Error(`Expected content-type to be ${b}, Actual: ${e}`)}var C=class{constructor(e,t,r){this.cacheManager=null;this.messageProcessor=null;this.baseUrl=e.baseUrl||"",this.headers=e.headers||{"Content-Type":"application/json"},this.overErrorTimer=e.overErrorTimer||60*1e3,this.currentEventHandlers=t||{onMessage:()=>{}},this.abortController=null,this.streamTimer=null,r&&(this.cacheManager=new u({maxCacheSize:r.maxCacheSize,cacheTimeout:r.cacheTimeout}),this.messageProcessor=new m(r.expectedSeq,this.cacheManager,this.currentEventHandlers.onMessage,r.handleValidateMessageFormat,r.getIndexValue))}async sendStreamRequest(e,t){this.currentEventHandlers=t||this.currentEventHandlers,this.abortController=new AbortController;try{this.startTimer(),await this.executeFetchRequest(e)}catch(r){this.handleRequestError()}finally{this.clearTimer()}}disconnect(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.clearTimer()}async executeFetchRequest(e){var t;await w(this.baseUrl,{method:"POST",headers:this.headers,body:JSON.stringify(this.buildRequestPayload(e)),openWhenHidden:!0,signal:(t=this.abortController)==null?void 0:t.signal,onopen:async r=>{this.handleOpenResponse(r)},onmessage:r=>this.handleServerMessage(r),onclose:()=>this.handleStreamClose(),onerror:()=>this.handleStreamError()})}handleServerMessage(e){var t,r,s,i;this.resetTimer();try{let n=JSON.parse(e.data);if(this.messageProcessor){this.messageProcessor.processMessage(n);return}(r=(t=this.currentEventHandlers)==null?void 0:t.onMessage)==null||r.call(t,n),this.currentMessage=n}catch(n){(i=(s=this.currentEventHandlers)==null?void 0:s.onParseError)==null||i.call(s,this.currentMessage)}}buildRequestPayload(e){return R({},e)}handleOpenResponse(e){var r,s,i,n;e.ok&&e.headers.get("content-type")==="text/event-stream"||(e.status>=400&&e.status<500&&e.status!==429&&((s=(r=this.currentEventHandlers)==null?void 0:r.onServerError)==null||s.call(r,this.currentMessage)),(n=(i=this.currentEventHandlers)==null?void 0:i.onConnectionError)==null||n.call(i,this.currentMessage))}handleStreamClose(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onClose)==null||t.call(e,this.currentMessage),this.clearTimer()}handleStreamError(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onServerError)==null||t.call(e,this.currentMessage),this.clearTimer()}handleRequestError(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onServerError)==null||t.call(e,this.currentMessage),this.clearTimer()}startTimer(){this.streamTimer=setTimeout(()=>{var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onStreamConnectionError)==null||t.call(e,this.currentMessage),this.disconnect()},this.overErrorTimer)}resetTimer(){this.clearTimer(),this.startTimer()}clearTimer(){this.streamTimer&&(clearTimeout(this.streamTimer),this.streamTimer=null)}};var E=class{constructor(e,t,r,s=""){this.messageQueue=[],this.delay=e,this.onMessage=t,this.onFinish=r,this.isProcessing=!1,this.stopFlag=!1,this.timeoutId=null,s&&this.add(s)}add(e){if(typeof e!="string"||this.stopFlag)return;let t=e.split("");this.messageQueue.push(...t),this.isProcessing||this.start()}setOnComplete(e){this.onFinish=e}start(){this.processQueue()}processQueue(){if(this.stopFlag||this.messageQueue.length===0){this.isProcessing=!1,this.messageQueue.length===0&&this.onFinish();return}this.isProcessing=!0;let e=this.messageQueue.shift();this.onMessage(e),this.timeoutId=setTimeout(()=>{this.processQueue()},this.delay)}stop(){this.stopFlag=!0}immediatelyStop(){clearTimeout(this.timeoutId),this.messageQueue=[],this.isProcessing=!1,this.stopFlag=!1,this.onFinish()}};return _(X);})();
