var p=Object.defineProperty;var d=Object.getOwnPropertySymbols;var g=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var u=(a,e,t)=>e in a?p(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,m=(a,e)=>{for(var t in e||(e={}))g.call(e,t)&&u(a,t,e[t]);if(d)for(var t of d(e))v.call(e,t)&&u(a,t,e[t]);return a};var o=class{constructor(e={}){this.messageCache=new Map,this.maxCacheSize=e.maxCacheSize||100,this.cacheTimeout=e.cacheTimeout||5e3,this.cleanupInterval=null,this.initCleanupCycle()}initCleanupCycle(){this.cleanupInterval=setInterval(()=>this.cleanup(),3e4)}cleanup(){this.applyTimeBasedEviction(),this.applySizeBasedEviction()}applyTimeBasedEviction(){let e=Date.now();Array.from(this.messageCache.entries()).forEach(([t,{timestamp:r}])=>{e-r>=this.cacheTimeout&&this.messageCache.delete(t)})}applySizeBasedEviction(){for(;this.messageCache.size>=this.maxCacheSize;){let e=Array.from(this.messageCache.keys())[0];this.messageCache.delete(e)}}cacheMessage(e,t){this.applySizeBasedEviction(),this.messageCache.set(e,{data:t,timestamp:Date.now()})}getCachedMessage(e){let t=this.messageCache.get(e);if(t){if(Date.now()-t.timestamp>this.cacheTimeout){this.messageCache.delete(e);return}return t}}deleteMessage(e){this.messageCache.delete(e)}clear(){this.messageCache.clear()}};var h=class{constructor(e=0,t,r,s,i){this.expectedSeq=0;this.expectedSeq=e,this.cacheManager=t,this.handleAppMessage=r,this.handleValidateMessageFormat=s,this.getIndexValue=i}processMessage(e){try{this.handleValidateMessageFormat(e);let t=this.getIndexValue(e);t===this.expectedSeq?this.handleCurrentMessage(e):t>this.expectedSeq&&this.cacheManager.cacheMessage(t,e)}catch(t){console.error("\u6D88\u606F\u5904\u7406\u9519\u8BEF:",t)}}handleCurrentMessage(e){this.handleAppMessage(e),this.expectedSeq++,this.checkCacheForNext()}checkCacheForNext(){for(;this.cacheManager.messageCache.has(this.expectedSeq);){let e=this.cacheManager.getCachedMessage(this.expectedSeq);e&&(this.handleAppMessage(e.data),this.cacheManager.deleteMessage(this.expectedSeq),this.expectedSeq++)}}};import{fetchEventSource as y}from"@microsoft/fetch-event-source";var c=class{constructor(e,t,r){this.cacheManager=null;this.messageProcessor=null;this.baseUrl=e.baseUrl||"",this.headers=e.headers||{"Content-Type":"application/json"},this.overErrorTimer=e.overErrorTimer||60*1e3,this.currentEventHandlers=t||{onMessage:()=>{}},this.abortController=null,this.streamTimer=null,r&&(this.cacheManager=new o({maxCacheSize:r.maxCacheSize,cacheTimeout:r.cacheTimeout}),this.messageProcessor=new h(r.expectedSeq,this.cacheManager,this.currentEventHandlers.onMessage,r.handleValidateMessageFormat,r.getIndexValue))}async sendStreamRequest(e,t){this.currentEventHandlers=t||this.currentEventHandlers,this.abortController=new AbortController;try{this.startTimer(),await this.executeFetchRequest(e)}catch(r){this.handleRequestError()}finally{this.clearTimer()}}disconnect(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.clearTimer()}async executeFetchRequest(e){var t;await y(this.baseUrl,{method:"POST",headers:this.headers,body:JSON.stringify(this.buildRequestPayload(e)),openWhenHidden:!0,signal:(t=this.abortController)==null?void 0:t.signal,onopen:async r=>{this.handleOpenResponse(r)},onmessage:r=>this.handleServerMessage(r),onclose:()=>this.handleStreamClose(),onerror:()=>this.handleStreamError()})}handleServerMessage(e){var t,r,s,i;this.resetTimer();try{let n=JSON.parse(e.data);if(this.messageProcessor){this.messageProcessor.processMessage(n);return}(r=(t=this.currentEventHandlers)==null?void 0:t.onMessage)==null||r.call(t,n),this.currentMessage=n}catch(n){(i=(s=this.currentEventHandlers)==null?void 0:s.onParseError)==null||i.call(s,this.currentMessage)}}buildRequestPayload(e){return m({},e)}handleOpenResponse(e){var r,s,i,n;e.ok&&e.headers.get("content-type")==="text/event-stream"||(e.status>=400&&e.status<500&&e.status!==429&&((s=(r=this.currentEventHandlers)==null?void 0:r.onServerError)==null||s.call(r,this.currentMessage)),(n=(i=this.currentEventHandlers)==null?void 0:i.onConnectionError)==null||n.call(i,this.currentMessage))}handleStreamClose(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onClose)==null||t.call(e,this.currentMessage),this.clearTimer()}handleStreamError(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onServerError)==null||t.call(e,this.currentMessage),this.clearTimer()}handleRequestError(){var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onServerError)==null||t.call(e,this.currentMessage),this.clearTimer()}startTimer(){this.streamTimer=setTimeout(()=>{var e,t;(t=(e=this.currentEventHandlers)==null?void 0:e.onStreamConnectionError)==null||t.call(e,this.currentMessage),this.disconnect()},this.overErrorTimer)}resetTimer(){this.clearTimer(),this.startTimer()}clearTimer(){this.streamTimer&&(clearTimeout(this.streamTimer),this.streamTimer=null)}};var l=class{constructor(e,t,r,s=""){this.messageQueue=[],this.delay=e,this.onMessage=t,this.onFinish=r,this.isProcessing=!1,this.stopFlag=!1,this.timeoutId=null,s&&this.add(s)}add(e){if(typeof e!="string"||this.stopFlag)return;let t=e.split("");this.messageQueue.push(...t),this.isProcessing||this.start()}setOnComplete(e){this.onFinish=e}start(){this.processQueue()}processQueue(){if(this.stopFlag||this.messageQueue.length===0){this.isProcessing=!1,this.messageQueue.length===0&&this.onFinish();return}this.isProcessing=!0;let e=this.messageQueue.shift();this.onMessage(e),this.timeoutId=setTimeout(()=>{this.processQueue()},this.delay)}stop(){this.stopFlag=!0}immediatelyStop(){clearTimeout(this.timeoutId),this.messageQueue=[],this.isProcessing=!1,this.stopFlag=!1,this.onFinish()}};export{o as CacheManager,h as MessageProcessor,c as StreamFetchClient,l as TypeWriterManage};
